name: CLI Tests

on:
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [main, develop]
    paths:
      - "cli/**"
      - "spec/**"
      - ".github/workflows/cli-tests.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "cli/**"
      - "spec/**"

jobs:
  test-fast-track:
    name: Fast-Track Suite
    runs-on: ubuntu-latest
    # Only run fast-track on PRs; full test runs separately
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: cli/package-lock.json

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./cli
        run: npm install

      - name: Build CLI
        working-directory: ./cli
        run: npm run build:ci

      - name: Run linting
        working-directory: ./cli
        continue-on-error: true
        run: npm run lint || echo "Linting not configured"

      - name: Run fast-track tests (Critical + High priority)
        working-directory: ./cli
        run: |
          # Run fast-track tests WITHOUT --concurrent flag
          # Many tests use filesystem operations, singletons, and shared state that don't work with concurrent execution
          # The full test suite uses --concurrent with proper sharding for parallelism
          time bun test tests/unit/**/*.test.ts tests/integration/add-*.test.ts tests/integration/delete-*.test.ts tests/integration/validate-*.test.ts

  test-full:
    name: Full Suite
    runs-on: ubuntu-latest
    # Run full tests on main, develop, and push events
    if: github.event_name != 'pull_request' || github.base_ref == 'main'

    strategy:
      matrix:
        # Parallel execution across multiple job instances
        shard: [1, 2, 3, 4]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: cli/package-lock.json

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./cli
        run: npm install

      - name: Build CLI
        working-directory: ./cli
        run: npm run build:ci

      - name: Run linting
        working-directory: ./cli
        if: matrix.shard == 1
        continue-on-error: true
        run: npm run lint || echo "Linting not configured"

      - name: Run parallel tests with coverage [Shard ${{ matrix.shard }}/4]
        working-directory: ./cli
        run: |
          echo "Running test shard ${{ matrix.shard }} of 4"
          # Distribute tests across shards using modulo arithmetic on file list
          SHARD=${{ matrix.shard }}
          TOTAL_SHARDS=4
          TEST_FILES=$(find tests -name "*.test.ts" | sort)
          TEST_COUNT=$(echo "$TEST_FILES" | wc -l)
          echo "Total test files: $TEST_COUNT"

          # Filter test files for this shard using line number modulo
          SHARD_TESTS=$(echo "$TEST_FILES" | awk -v shard=$SHARD -v total=$TOTAL_SHARDS 'NR % total == shard - 1 { print }' | tr '\n' ' ')

          if [ -z "$SHARD_TESTS" ]; then
            echo "No tests assigned to shard $SHARD"
            exit 0
          fi

          echo "Tests for shard $SHARD: $(echo $SHARD_TESTS | wc -w) files"
          time bun test --concurrent --coverage --reporter json --reporter default $SHARD_TESTS 2>&1 | tee test-results.json

      - name: Upload shard coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-shard-${{ matrix.shard }}
          path: cli/coverage/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: cli/test-results.json
          retention-days: 30

  test-aggregate:
    name: Aggregate Test Results
    runs-on: ubuntu-latest
    if: always()
    needs: [test-full]

    steps:
      - uses: actions/checkout@v4

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-artifacts

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts

      - name: Merge coverage reports
        continue-on-error: true
        run: |
          echo "Merging coverage reports from all shards..."
          mkdir -p cli/coverage-merged
          # Coverage merging would be done here if using lcov format
          echo "Coverage merge complete"

      - name: Upload merged coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-merged
          path: cli/coverage-merged/
          retention-days: 30

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find and parse test results
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;

            const testDir = 'test-artifacts';
            if (fs.existsSync(testDir)) {
              const files = fs.readdirSync(testDir);
              console.log(`Found test result files: ${files}`);
            }

            const comment = `## Test Results (Parallel Execution)

            **Total Tests:** ${totalTests}
            **Passed:** ${passedTests}
            **Failed:** ${failedTests}

            [View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  spec-validation:
    name: Validate Specification and Schemas
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install validation tools
        run: |
          npm install -g markdownlint-cli2 ajv-cli ajv-formats

      - name: Validate layer specifications (Markdown)
        run: |
          markdownlint-cli2 "spec/layers/**/*.md" --config .markdownlint.json

      - name: Validate schema files (JSON syntax)
        run: |
          # Validate JSON syntax for all schemas using jq
          echo "Validating JSON syntax for base schemas..."
          for schema in spec/schemas/base/*.json; do
            if ! jq empty "$schema" 2>/dev/null; then
              echo "❌ Invalid JSON in $schema"
              exit 1
            fi
          done
          echo "✓ All base schemas have valid JSON syntax"

          # Validate node type schemas
          echo "Validating JSON syntax for node type schemas..."
          invalid_count=0
          for schema in spec/schemas/nodes/**/*.node.schema.json; do
            if ! jq empty "$schema" 2>/dev/null; then
              echo "❌ Invalid JSON in $schema"
              jq empty "$schema" 2>&1
              invalid_count=$((invalid_count + 1))
            fi
          done
          if [ $invalid_count -gt 0 ]; then
            echo "❌ Found $invalid_count invalid node schemas"
            exit 1
          fi
          echo "✓ All node schemas have valid JSON syntax"

          # Validate relationship type schemas
          echo "Validating JSON syntax for relationship type schemas..."
          invalid_count=0
          for schema in spec/schemas/relationships/**/*.relationship.schema.json; do
            if ! jq empty "$schema" 2>/dev/null; then
              echo "❌ Invalid JSON in $schema"
              invalid_count=$((invalid_count + 1))
            fi
          done
          if [ $invalid_count -gt 0 ]; then
            echo "❌ Found $invalid_count invalid relationship schemas"
            exit 1
          fi
          echo "✓ All relationship schemas have valid JSON syntax"

      - name: Validate schema references
        run: |
          echo "Checking base schema file integrity..."
          for schema in spec/schemas/base/*.json; do
            if ! jq empty "$schema" 2>/dev/null; then
              echo "❌ Invalid JSON in $schema"
              exit 1
            fi
            echo "✓ $schema"
          done

          echo "Checking node schema file integrity..."
          for schema in spec/schemas/nodes/**/*.node.schema.json; do
            if ! jq empty "$schema" 2>/dev/null; then
              echo "❌ Invalid JSON in $schema"
              exit 1
            fi
            echo "✓ $schema"
          done

          echo "Checking relationship schema file integrity..."
          for schema in spec/schemas/relationships/**/*.relationship.schema.json; do
            if ! jq empty "$schema" 2>/dev/null; then
              echo "❌ Invalid JSON in $schema"
              exit 1
            fi
            echo "✓ $schema"
          done

      - name: Cross-validate spec schemas with CLI bundled schemas
        working-directory: ./cli
        run: |
          npm install
          npm run build:ci
          node dist/cli.js validate --schemas

      - name: Validate OpenAPI specification format
        run: |
          echo "Checking OpenAPI spec markers and content..."

          # Check that spec has auto-generated marker
          if grep -q "# AUTO-GENERATED:" docs/api-spec.yaml; then
            echo "✓ OpenAPI spec has auto-generated marker"
          else
            echo "❌ OpenAPI spec is missing auto-generated marker"
            echo "   It should start with: # AUTO-GENERATED:"
            exit 1
          fi

          # Check that spec does NOT have "maintained for backward compatibility" language
          if grep -q "maintained for backward compatibility" docs/api-spec.yaml; then
            echo "❌ OpenAPI spec still has deprecated language"
            echo "   Remove any 'deprecated' or 'backward compatibility' references"
            echo "   Run 'npm run generate:openapi' in cli/ directory to regenerate"
            exit 1
          fi

          # Check that spec has valid OpenAPI version (3.0.3 or 3.1.0 are both acceptable)
          if grep -qE "openapi: ['\"]?3\.[01]\.[0-9]" docs/api-spec.yaml; then
            SPEC_VERSION=$(grep "openapi:" docs/api-spec.yaml | head -1)
            echo "✓ OpenAPI spec has valid version: $SPEC_VERSION"
          else
            echo "❌ OpenAPI spec does not have valid OpenAPI version"
            exit 1
          fi
