version: 2.1

orbs:
  node: circleci/node@5.1.0

executors:
  dr-executor:
    docker:
      - image: cimg/node:20.10
    working_directory: ~/project
    environment:
      NODE_OPTIONS: --max-old-space-size=4096

jobs:
  validate-schema:
    executor: dr-executor
    steps:
      - checkout
      - node/install-packages:
          cache-path: ~/project/node_modules
          override-ci-command: npm install
      - run:
          name: Install DR CLI
          command: npm install -g @documentation-robotics/cli
      - run:
          name: Validate DR Model Schema
          command: |
            dr validate --strict --output json | tee validation-schema.json
      - store_artifacts:
          path: validation-schema.json
          destination: validation/schema.json
      - store_test_results:
          path: validation-schema.json

  validate-relationships:
    executor: dr-executor
    steps:
      - checkout
      - node/install-packages:
          cache-path: ~/project/node_modules
      - run:
          name: Install DR CLI
          command: npm install -g @documentation-robotics/cli
      - run:
          name: Validate Cross-Layer Relationships
          command: |
            dr validate --validate-links --strict-links --output json | tee validation-links.json
      - store_artifacts:
          path: validation-links.json
          destination: validation/links.json

  conformance-check:
    executor: dr-executor
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Install DR CLI
          command: npm install -g @documentation-robotics/cli
      - run:
          name: Check Standards Conformance
          command: |
            dr conformance --standards archimate,openapi || true
      - store_artifacts:
          path: conformance-report.json
          destination: validation/conformance.json

  export-archimate:
    executor: dr-executor
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Install DR CLI
          command: npm install -g @documentation-robotics/cli
      - run:
          name: Export ArchiMate XML
          command: |
            mkdir -p exports/archimate
            dr export --format archimate --output exports/archimate/
      - store_artifacts:
          path: exports/archimate
          destination: exports/archimate
      - persist_to_workspace:
          root: .
          paths:
            - exports/archimate

  export-openapi:
    executor: dr-executor
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Install DR CLI
          command: npm install -g @documentation-robotics/cli
      - run:
          name: Export OpenAPI Specifications
          command: |
            mkdir -p exports/openapi
            dr export --format openapi --output exports/openapi/
      - store_artifacts:
          path: exports/openapi
          destination: exports/openapi
      - persist_to_workspace:
          root: .
          paths:
            - exports/openapi

  export-documentation:
    executor: dr-executor
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Install DR CLI
          command: npm install -g @documentation-robotics/cli
      - run:
          name: Export Documentation
          command: |
            mkdir -p exports/{markdown,diagrams,schemas,graphs}
            dr export --format markdown --output exports/markdown/
            dr export --format plantuml --output exports/diagrams/
            dr export --format json-schema --output exports/schemas/
            dr export --format graphml --output exports/graphs/
      - store_artifacts:
          path: exports
          destination: exports
      - persist_to_workspace:
          root: .
          paths:
            - exports

  publish-documentation:
    executor: dr-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Prepare Documentation Site
          command: |
            mkdir -p public
            cp -r exports/markdown/* public/ || true
            cp -r exports/diagrams public/diagrams || true
      - store_artifacts:
          path: public
          destination: documentation-site

workflows:
  version: 2

  validate-on-pr:
    jobs:
      - validate-schema:
          filters:
            branches:
              ignore: main
      - validate-relationships:
          filters:
            branches:
              ignore: main
          requires:
            - validate-schema

  validate-and-export:
    jobs:
      - validate-schema:
          filters:
            branches:
              only: main
      - validate-relationships:
          filters:
            branches:
              only: main
          requires:
            - validate-schema
      - conformance-check:
          filters:
            branches:
              only: main
          requires:
            - validate-schema
            - validate-relationships
      - export-archimate:
          filters:
            branches:
              only: main
          requires:
            - validate-schema
            - validate-relationships
      - export-openapi:
          filters:
            branches:
              only: main
          requires:
            - validate-schema
            - validate-relationships
      - export-documentation:
          filters:
            branches:
              only: main
          requires:
            - validate-schema
            - validate-relationships
      - publish-documentation:
          filters:
            branches:
              only: main
          requires:
            - export-documentation

  scheduled-validation:
    triggers:
      - schedule:
          cron: "0 0 * * *" # Daily at midnight
          filters:
            branches:
              only: main
    jobs:
      - validate-schema
      - validate-relationships:
          requires:
            - validate-schema
      - conformance-check:
          requires:
            - validate-schema
            - validate-relationships
