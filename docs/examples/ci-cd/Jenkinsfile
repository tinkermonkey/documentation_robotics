pipeline {
    agent {
        docker {
            image 'node:20'
            args '-u root'
        }
    }

    environment {
        NODE_OPTIONS = '--max-old-space-size=4096'
        DR_OUTPUT_DIR = 'exports'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }

    stages {
        stage('Setup') {
            steps {
                echo 'Installing Documentation Robotics CLI...'
                sh '''
                    node --version
                    npm --version
                    npm install -g @documentation-robotics/cli
                    dr --version
                '''
            }
        }

        stage('Validate Model') {
            parallel {
                stage('Schema Validation') {
                    steps {
                        echo 'Validating DR model schema and structure...'
                        sh 'dr validate --strict --output json > validation-schema.json || true'
                        script {
                            def exitCode = sh(
                                script: 'dr validate --strict',
                                returnStatus: true
                            )
                            if (exitCode != 0) {
                                error "Schema validation failed"
                            }
                        }
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'validation-schema.json', allowEmptyArchive: true
                        }
                    }
                }

                stage('Relationship Validation') {
                    steps {
                        echo 'Validating cross-layer relationships...'
                        sh 'dr validate --validate-links --strict-links --output json > validation-links.json || true'
                        script {
                            def exitCode = sh(
                                script: 'dr validate --validate-links --strict-links',
                                returnStatus: true
                            )
                            if (exitCode != 0) {
                                error "Relationship validation failed"
                            }
                        }
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'validation-links.json', allowEmptyArchive: true
                        }
                    }
                }
            }
        }

        stage('Conformance Check') {
            when {
                branch 'main'
            }
            steps {
                echo 'Checking conformance to industry standards...'
                sh 'dr conformance --standards archimate,openapi || true'
            }
        }

        stage('Export Documentation') {
            when {
                branch 'main'
            }
            steps {
                echo 'Exporting all documentation formats...'
                sh '''
                    mkdir -p ${DR_OUTPUT_DIR}/{archimate,openapi,schemas,diagrams,docs,graphs}

                    echo "Exporting ArchiMate..."
                    dr export --format archimate --output ${DR_OUTPUT_DIR}/archimate/

                    echo "Exporting OpenAPI..."
                    dr export --format openapi --output ${DR_OUTPUT_DIR}/openapi/

                    echo "Exporting JSON Schemas..."
                    dr export --format json-schema --output ${DR_OUTPUT_DIR}/schemas/

                    echo "Exporting PlantUML diagrams..."
                    dr export --format plantuml --output ${DR_OUTPUT_DIR}/diagrams/

                    echo "Exporting Markdown documentation..."
                    dr export --format markdown --output ${DR_OUTPUT_DIR}/docs/

                    echo "Exporting GraphML graphs..."
                    dr export --format graphml --output ${DR_OUTPUT_DIR}/graphs/
                '''
            }
            post {
                success {
                    archiveArtifacts artifacts: 'exports/**/*', allowEmptyArchive: false
                }
            }
        }

        stage('Generate Reports') {
            when {
                branch 'main'
            }
            steps {
                echo 'Generating architecture reports...'
                sh '''
                    # Generate layer statistics
                    dr list --all --output json > ${DR_OUTPUT_DIR}/model-statistics.json

                    # Generate relationship graph
                    dr trace --all --output json > ${DR_OUTPUT_DIR}/relationship-graph.json
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'exports/model-statistics.json,exports/relationship-graph.json', allowEmptyArchive: true
                }
            }
        }

        stage('Publish Documentation') {
            when {
                branch 'main'
            }
            steps {
                echo 'Publishing documentation...'
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'exports/docs',
                    reportFiles: 'index.html',
                    reportName: 'Architecture Documentation',
                    reportTitles: 'DR Model Documentation'
                ])
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo '✓ DR model validation and export completed successfully!'
        }
        failure {
            echo '✗ DR model validation failed!'
            script {
                if (env.BRANCH_NAME == 'main') {
                    emailext(
                        subject: "DR Model Validation Failed - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """DR model validation failed for build ${env.BUILD_NUMBER}.

                        Check the build logs for details: ${env.BUILD_URL}

                        Validation reports are available in the artifacts.
                        """,
                        to: '${DEFAULT_RECIPIENTS}'
                    )
                }
            }
        }
        unstable {
            echo '⚠ DR model validation completed with warnings'
        }
    }
}
