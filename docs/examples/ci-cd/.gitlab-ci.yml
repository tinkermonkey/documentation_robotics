stages:
  - validate
  - export
  - deploy

variables:
  NODE_VERSION: "20"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .npm/
    - node_modules/

.dr_install: &dr_install
  before_script:
    - npm ci --cache .npm --prefer-offline || npm install
    - npm install -g @documentation-robotics/cli
    - dr --version

# Validation Jobs

validate:schema:
  stage: validate
  image: node:${NODE_VERSION}
  <<: *dr_install
  script:
    - echo "Validating DR model schema and structure..."
    - dr validate --strict --output json
  artifacts:
    when: always
    paths:
      - dr-validation-report.json
    reports:
      junit: dr-validation-report.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:relationships:
  stage: validate
  image: node:${NODE_VERSION}
  <<: *dr_install
  script:
    - echo "Validating cross-layer relationships..."
    - dr validate --validate-links --strict-links --output json
  artifacts:
    when: always
    paths:
      - dr-links-validation.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:conformance:
  stage: validate
  image: node:${NODE_VERSION}
  <<: *dr_install
  script:
    - echo "Checking conformance to standards..."
    - dr conformance --standards archimate,openapi
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Export Jobs

export:archimate:
  stage: export
  image: node:${NODE_VERSION}
  <<: *dr_install
  script:
    - mkdir -p exports/archimate
    - dr export --format archimate --output exports/archimate/
  artifacts:
    paths:
      - exports/archimate/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - validate:schema
    - validate:relationships

export:openapi:
  stage: export
  image: node:${NODE_VERSION}
  <<: *dr_install
  script:
    - mkdir -p exports/openapi
    - dr export --format openapi --output exports/openapi/
  artifacts:
    paths:
      - exports/openapi/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - validate:schema
    - validate:relationships

export:documentation:
  stage: export
  image: node:${NODE_VERSION}
  <<: *dr_install
  script:
    - mkdir -p exports/docs
    - dr export --format markdown --output exports/docs/
    - dr export --format plantuml --output exports/docs/diagrams/
  artifacts:
    paths:
      - exports/docs/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - validate:schema
    - validate:relationships

export:all:
  stage: export
  image: node:${NODE_VERSION}
  <<: *dr_install
  script:
    - mkdir -p exports/complete
    - dr export --format all --output exports/complete/
  artifacts:
    paths:
      - exports/complete/
    expire_in: 90 days
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - validate:schema
    - validate:relationships

# Deployment Job

deploy:pages:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "Deploying documentation to GitLab Pages..."
    - mkdir -p public
    - cp -r exports/docs/* public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - export:documentation
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME
