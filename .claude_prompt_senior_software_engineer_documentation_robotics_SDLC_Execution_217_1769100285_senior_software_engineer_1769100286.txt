
You are a Senior Software Engineer.

I implement clean, well thought out code with proper error handling and maintainable architecture.

**Issue Title**: [CRITICAL] Layer restoration failures only warn instead of failing

**Description**:
## Issue
During model restoration in `staging-area.ts`, layer restoration failures are only logged with `console.warn()` and execution continues. Model could be partially restored without user awareness.

## Location
`cli/src/core/staging-area.ts:843-880`

## Impact
**Severity:** CRITICAL | **Confidence:** 90%

User sees "restoration completed" message but model is actually incomplete. Subsequent validation or operations fail with confusing errors about missing elements or layers.

## Hidden Errors
- Backup layer directory missing
- Layer file corrupted in backup
- Insufficient permissions to write to model directory
- Disk full during restoration
- Individual file restoration failures masked by blanket catch

## Recommendation
1. Track critical layer restoration failures
2. Throw error if any critical layers fail to restore
3. Provide detailed error summary showing which layers failed
4. Include per-layer restoration status in output

## Related
PR #197 - Staged changeset functionality


## Previous Work and Feedback

The following is the complete history of agent outputs and feedback for this issue.
This includes outputs from ALL previous stages (design, testing, QA, etc.) and any
user feedback. If this issue was returned from testing or QA, pay special attention
to their feedback and address all issues they identified.

## Output from Software Architect

**software_architect** (agent):
# Architecture Design

---

Now I have a comprehensive understanding of the current architecture. Let me analyze the existing `projection-engine.ts` to understand how projections work, and then synthesize the full architecture design.

## Executive Summary

The current changeset system in Documentation Robotics tracks changes but immediately applies them to the base model. The proposed staging architecture introduces a **delta-only virtual projection layer** that isolates staged changes from the base model until explicit commit. This mirrors Git's staging semantics while preserving the federated 12-layer architecture integrity.

**Core Architectural Shift:**
- **Current**: Changes tracked in changesets but simultaneously written to base model layers
- **Proposed**: Changes written only to staging area; base model remains immutable until commit

## System Architecture

### Current State Analysis

The existing changeset implementation (`cli/src/core/changeset.ts:1-425`) operates as a **passive tracking system**:

1. **ActiveChangesetContext** (`cli/src/core/active-changeset.ts`) intercepts model mutations via `trackChange()` calls in add/update/delete commands
2. Changes are recorded in `.dr/changesets/{name}.json` with before/after snapshots
3. However, the base model is **simultaneously modified**â€”changesets serve only as audit trails
4. The `apply` and `revert` commands replay or undo changes, but expect the model state to potentially have diverged

### Proposed Staging Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Documentation Robotics                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Base Model        â”‚    â”‚            Staging Area                 â”‚ â”‚
â”‚  â”‚   (Immutable)       â”‚    â”‚   documentation-robotics/changesets/    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ documentation-      â”‚    â”‚ {changeset-id}/                         â”‚ â”‚
â”‚  â”‚ robotics/model/     â”‚    â”‚   metadata.yaml                         â”‚ â”‚
â”‚  â”‚   manifest.yaml     â”‚â—„â”€â”€â”€â”¤   changes.yaml                          â”‚ â”‚
â”‚  â”‚   01_motivation/    â”‚    â”‚   base_snapshot.sha256                  â”‚ â”‚
â”‚  â”‚   02_business/      â”‚    â”‚                                         â”‚ â”‚
â”‚  â”‚   ...               â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚   relationships.yamlâ”‚                     â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚                          â”‚
â”‚              â–²                               â”‚                          â”‚
â”‚              â”‚                               â–¼                          â”‚
â”‚              â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚              â”‚                  â”‚   Virtual Projection    â”‚             â”‚
â”‚              â”‚                  â”‚   Engine                â”‚             â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ (Merged View Computer)  â”‚             â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                              â”‚                          â”‚
â”‚                                              â–¼                          â”‚
â”‚                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                                 â”‚   Validation Pipeline   â”‚             â”‚
â”‚                                 â”‚ (Schema + Reference +   â”‚             â”‚
â”‚                                 â”‚  Semantic Validation)   â”‚             â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Design

#### 1. StagingAreaManager (New)
```typescript
// cli/src/core/staging-area.ts
interface StagingAreaManager {
  // Changeset lifecycle
  create(name: string, description?: string): Promise<StagedChangeset>
  load(name: string): Promise<StagedChangeset | null>
  list(): Promise<StagedChangeset[]>
  delete(name: string): Promise<void>
  
  // Staging operations
  stage(changesetId: string, change: StagedChange): Promise<void>
  unstage(changesetId: string, elementId: string): Promise<void>
  discard(changesetId: string): Promise<void>
  
  // Commit operations
  commit(changesetId: string, options?: CommitOptions): Promise<CommitResult>
  
  // Base snapshot tracking
  captureBaseSnapshot(changesetId: string): Promise<string>
  detectDrift(changesetId: string): Promise<DriftReport>
}
```

#### 2. VirtualProjectionEngine (New)
```typescript
// cli/src/core/virtual-projection.ts
interface VirtualProjectionEngine {
  // Create merged view without modifying base
  projectElement(
    baseModel: Model, 
    changesetId: string, 
    elementId: string
  ): Promise<Element | null>
  
  projectLayer(
    baseModel: Model, 
    changesetId: string, 
    layerName: string
  ): Promise<Layer>
  
  projectModel(
    baseModel: Model, 
    changesetId: string
  ): Promise<ProjectedModel>
  
  // Diff computation
  computeDiff(
    baseModel: Model, 
    changesetId: string
  ): Promise<ModelDiff>
}
```

#### 3. Enhanced Change Model
```typescript
// Extended from current Change interface
interface StagedChange {
  type: 'add' | 'update' | 'delete'
  elementId: string
  layerName: string
  before?: Record<string, unknown>  // Snapshot at staging time
  after?: Record<string, unknown>   // Proposed state
  timestamp: string
  sequenceNumber: number            // Ordering for replay
}

interface StagedChangeset {
  id: string
  name: string
  description?: string
  created: string
  modified: string
  status: 'draft' | 'staged' | 'committed' | 'discarded'
  
  // New fields for staging
  baseSnapshot: string              // Hash of base model at creation
  changes: StagedChange[]
  
  // Tracking
  stats: {
    additions: number
    modifications: number
    deletions: number
  }
}
```

### Data Flow: Staging Operation

```
User: dr add application-component new-service --name "New Service"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ add command    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StagingInterceptor         â”‚
â”‚ (replaces direct model     â”‚
â”‚  mutation when active      â”‚
â”‚  changeset exists)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StagingAreaManager.stage() â”‚
â”‚ - Validate element schema  â”‚
â”‚ - Record in changes.yaml   â”‚
â”‚ - Update changeset stats   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base Model UNCHANGED       â”‚
â”‚ (mutation blocked)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow: Preview Operation

```
User: dr changeset preview --layer=application

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ changeset preview command  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Base Model            â”‚
â”‚ (read-only)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Staged Changes        â”‚
â”‚ from changes.yaml          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VirtualProjectionEngine    â”‚
â”‚ .projectLayer()            â”‚
â”‚ - Clone base layer         â”‚
â”‚ - Apply staged additions   â”‚
â”‚ - Apply staged updates     â”‚
â”‚ - Remove staged deletions  â”‚
â”‚ - Return merged view       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Display Merged Layer       â”‚
â”‚ (computed, not persisted)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow: Commit Operation

```
User: dr changeset commit

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ changeset commit command   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Detect Base Drift       â”‚
â”‚    Compare current vs      â”‚
â”‚    baseSnapshot hash       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ (drift detected? warn or --force)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Validate Merged View    â”‚
â”‚    Project full model      â”‚
â”‚    Run validation pipeline â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ (validation passes)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Apply to Base Model     â”‚
â”‚    For each staged change: â”‚
â”‚    - add: layer.addElement â”‚
â”‚    - update: merge props   â”‚
â”‚    - delete: removeElement â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Save Dirty Layers       â”‚
â”‚    model.saveDirtyLayers() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Update Manifest         â”‚
â”‚    Add to changeset_historyâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Update Changeset Status â”‚
â”‚    status: 'committed'     â”‚
â”‚    Clear staging area      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Scalability Design

### Changeset Storage Efficiency

The delta-only approach scales better than shadow copies:

| Approach | Storage for 1000-element model | 10 changesets |
|----------|-------------------------------|---------------|
| Shadow Copy | ~1000 elements Ã— 10 = ~10000 records | 10MB+ |
| Delta-Only | ~50 changes Ã— 10 = ~500 records | ~500KB |

### Projection Caching Strategy

```typescript
interface ProjectionCache {
  // Cache key: `${changesetId}:${layerName}:${changesetModified}`
  cache: Map<string, { layer: Layer; computedAt: string }>
  
  // Invalidation triggers
  invalidateOnStage(changesetId: string, layerName: string): void
  invalidateOnUnstage(changesetId: string, layerName: string): void
  invalidateOnDiscard(changesetId: string): void
  
  // TTL-based cleanup for memory efficiency
  maxAge: number  // e.g., 5 minutes
}
```

### Concurrent Changeset Handling

Multiple changesets can exist independently:
- Each changeset has its own `baseSnapshot` 
- Drift detection prevents conflicting commits
- No merge capability (intentional simplicity)â€”users must resolve conflicts manually

## Established Patterns

### Pattern 1: Command Interception via Active Context

Reuse the existing `ActiveChangesetContext` pattern but modify behavior:

```typescript
// Current: Tracks changes AND allows model mutation
await activeChangeset.trackChange('add', id, layer, undefined, element.toJSON());

// Proposed: Intercepts mutation, redirects to staging only
await stagingInterceptor.stageChange('add', id, layer, undefined, element.toJSON());
// Model mutation blocked when staging is active
```

### Pattern 2: Layer-Based Element Grouping

Maintain consistency with existing structure:
- Elements grouped by layer in staging changes
- Projection applies changes layer-by-layer
- Validation runs on projected layers individually

### Pattern 3: YAML-Based Persistence

Align with existing storage:
```yaml
# documentation-robotics/changesets/{id}/metadata.yaml
id: api-updates-2024
name: "API Layer Updates"
description: "Add new customer endpoints"
created: "2024-01-15T10:00:00Z"
modified: "2024-01-15T14:30:00Z"
status: staged
baseSnapshot: "sha256:abc123..."
stats:
  additions: 3
  modifications: 2
  deletions: 0
```

```yaml
# documentation-robotics/changesets/{id}/changes.yaml
- type: add
  elementId: api-endpoint-create-customer
  layerName: api
  sequenceNumber: 1
  timestamp: "2024-01-15T10:15:00Z"
  after:
    id: api-endpoint-create-customer
    name: "Create Customer"
    type: endpoint
    properties:
      method: POST
      path: /customers
```

### Pattern 4: Reference Validation Against Merged View

Cross-layer reference integrity uses the projected model:

```typescript
async validateReferences(changesetId: string): Promise<ValidationResult> {
  const projectedModel = await this.projectionEngine.projectModel(
    this.baseModel, 
    changesetId
  );
  
  // Validate references exist in projected state
  return this.referenceValidator.validate(projectedModel);
}
```

## Component Reuse

### Existing Components to Extend

| Component | Current Purpose | Staging Extension |
|-----------|----------------|-------------------|
| `Changeset` class | Change record container | Add `baseSnapshot`, extend status enum |
| `ChangesetManager` | CRUD for changesets | Move to `documentation-robotics/changesets/` path |
| `ActiveChangesetContext` | Track active changeset | Add `StagingInterceptor` role |
| `ProjectionEngine` | Element projection rules | Adapt for virtual merged views |
| Validation pipeline | Schema/reference checks | Run against projected model |

### New Components Required

| Component | Purpose |
|-----------|---------|
| `StagingAreaManager` | Manage staged changesets and changes |
| `VirtualProjectionEngine` | Compute merged model views |
| `BaseSnapshotManager` | Capture and compare model snapshots |
| `DriftDetector` | Identify base model changes since staging began |
| `StagingInterceptor` | Block model mutations, redirect to staging |

## Implementation Plan

### Phase 1: Storage Relocation and Data Model
- Migrate changeset storage from `.dr/changesets/` to `documentation-robotics/changesets/`
- Extend `ChangesetData` interface with `baseSnapshot` and new status values
- Implement `BaseSnapshotManager` for model hashing
- Add migration logic for existing changesets

### Phase 2: Staging Interception
- Create `StagingInterceptor` class
- Modify `add`, `update`, `delete` commands to check for active staging context
- Implement blocking behavior for model mutations when staging active
- Implement `stage()` and `unstage()` operations

### Phase 3: Virtual Projection Engine
- Implement `VirtualProjectionEngine` with layer and model projection
- Add projection caching with invalidation
- Implement `computeDiff()` for preview/diff commands
- Integrate with existing `ProjectionEngine` patterns

### Phase 4: Commit and Validation
- Implement drift detection with `detectDrift()`
- Add pre-commit validation against projected model
- Implement atomic commit with rollback on failure
- Update manifest `changeset_history` on commit

### Phase 5: CLI Commands
- Add `dr changeset staged [--layer]` command
- Add `dr changeset unstage <element-id>` command
- Add `dr changeset discard [element-id]` command
- Add `dr changeset preview [--layer]` command
- Add `dr changeset diff [--layer]` command
- Modify `dr changeset commit` for new workflow
- Add `--force` flag for drift override

### Phase 6: Export/Import and Collaboration
- Implement `dr changeset export` for portable YAML format
- Implement `dr changeset import` with base compatibility check
- Document Git-based collaboration workflows

### Phase 7: Testing and Migration
- Unit tests for all new components
- Integration tests for full staging workflow
- Migration scripts for existing changesets
- Performance benchmarks for projection caching

## Key Interfaces

### StagedChangeset
```typescript
interface StagedChangeset extends ChangesetData {
  baseSnapshot: string
  status: 'draft' | 'staged' | 'committed' | 'discarded'
}
```

### CommitOptions
```typescript
interface CommitOptions {
  force?: boolean        // Ignore drift warnings
  validate?: boolean     // Run validation (default: true)
  dryRun?: boolean       // Preview without applying
}
```

### CommitResult
```typescript
interface CommitResult {
  changeset: string
  committed: number
  validation: ValidationResult
  driftWarning?: DriftReport
}
```

### DriftReport
```typescript
interface DriftReport {
  baseSnapshotHash: string
  currentModelHash: string
  hasDrift: boolean
  affectedLayers: string[]
  affectedElements: string[]
}
```

## Risk Mitigation

### Data Loss Prevention
- Staged changes persist to filesystem immediately
- Git-trackable location enables version control
- Commit is atomic: all-or-nothing application

### Backward Compatibility
- Existing changesets migrated to new structure
- Status mapping: `draft` â†’ `staged`, `applied` â†’ `committed`
- Commands maintain existing CLI interface where possible

### Performance Considerations
- Projection caching reduces repeated computation
- Lazy loading compatible with staging operations
- Delta-only storage minimizes disk usage

---
_Generated by Orchestrator Bot ğŸ¤–_
_Processed by the software_architect agent_

IMPORTANT: Review all feedback carefully and address every issue that is not already addressed.


