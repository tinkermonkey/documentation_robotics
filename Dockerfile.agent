# ============================================================================
# Stage 1: Base Environment Setup
# ============================================================================
FROM clauditoreum-orchestrator:latest

# The base image already includes:
# - Claude CLI (REQUIRED - must be present)
# - Git CLI (REQUIRED - must be present)
# - GitHub CLI (REQUIRED - must be present)
# - Python 3.11
# - Essential build tools
# - procps package (provides 'ps' command needed by Claude CLI)

USER root

# ============================================================================
# Stage 2: Install Project-Specific Runtimes
# ============================================================================
# This project uses Python which is already in the base image
# Install libxml2 and libxslt development headers for lxml
RUN apt-get update && apt-get install -y --no-install-recommends \
    libxml2-dev \
    libxslt1-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Stage 3: Pre-install Dependencies (RECOMMENDED)
# ============================================================================
# Pre-installing dependencies speeds up agent startup time because the agent
# doesn't have to install them every time it runs.

# WORKDIR should match where the orchestrator will mount the project
WORKDIR /workspace/documentation_robotics

# NOTE: We do NOT copy pyproject.toml to avoid creating directories that conflict
# with the runtime mount. All dependencies are installed explicitly below.
# The source code (including pyproject.toml) comes from the runtime mount.

# Pre-install Python dependencies
# These match the dependencies from cli/pyproject.toml
# Core CLI dependencies
RUN pip install --no-cache-dir \
    'click>=8.1.0' \
    'pyyaml>=6.0' \
    'jsonschema>=4.17.0' \
    'pydantic>=2.0.0' \
    'rich>=13.0.0' \
    'python-dateutil>=2.8.0' \
    'packaging>=23.0'

# Template and graph dependencies
RUN pip install --no-cache-dir \
    'jinja2>=3.1.0' \
    'networkx>=3.0' \
    'jsonpath-ng>=1.5.0' \
    'lxml>=4.9.0' \
    'markdown>=3.4.0'

# Interactive prompts and text processing
RUN pip install --no-cache-dir \
    'questionary>=2.0.0' \
    'inflect>=7.0.0'

# Web server for visualization (aiohttp + watchdog)
RUN pip install --no-cache-dir \
    'aiohttp>=3.9.0' \
    'watchdog>=3.0.0'

# AI chat integration
RUN pip install --no-cache-dir \
    'anthropic>=0.75.0'

# Test stack (dev dependencies)
RUN pip install --no-cache-dir \
    'pytest>=7.0.0' \
    'pytest-cov>=4.0.0' \
    'pytest-asyncio>=0.21.0' \
    'pre-commit>=3.0.0' \
    'black>=23.0.0' \
    'mypy>=1.0.0' \
    'ruff>=0.1.0' \
    'types-PyYAML' \
    'types-python-dateutil'

# ============================================================================
# Stage 4: Ownership and Permissions
# ============================================================================
# Change ownership ONLY of what was installed, NOT source code
# Source code ownership is handled by the mount

# Python packages are already installed in /usr/local as root, no chown needed

# ============================================================================
# Stage 5: Switch to Runtime User
# ============================================================================
USER orchestrator

# ============================================================================
# Stage 6: Verification (MANDATORY)
# ============================================================================
# Verify all critical CLIs are present (from base image)
RUN claude --version && \
    git --version && \
    gh --version

# Verify project-specific tools - core dependencies
RUN python3 --version && \
    pip --version && \
    python3 -c "import click; import pydantic; import jsonschema; import networkx; print('Core dependencies available')"

# Verify visualization server dependencies
RUN python3 -c "import aiohttp; import watchdog; print('Visualization server dependencies available')"

# Verify test stack dependencies
RUN python3 -c "import pytest; import pytest_cov; import pytest_asyncio; print('Test stack dependencies available')"

# Verify AI integration
RUN python3 -c "import anthropic; print('Anthropic SDK available')"

# ============================================================================
# Default command
# ============================================================================
CMD ["/bin/bash"]
