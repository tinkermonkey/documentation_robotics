# Release Process for Documentation Robotics

This document describes the correct release workflow for both the Specification and CLI components.

## Critical Rule: Never Manually Edit Bundled Files

**IMPORTANT**: The following files should NEVER be manually edited:

- `cli/src/documentation_robotics/schemas/bundled/*.json` - Fetched from GitHub releases
- `cli/src/documentation_robotics/claude_integration/` - Copied from `integrations/claude_code/`
- `cli/src/documentation_robotics/copilot_integration/` - Copied from `integrations/github_copilot/`

These files are generated by `scripts/prepare_build.py` from authoritative sources. Manual edits will be overwritten and may cause version inconsistencies.

## Release Types

There are two independent release types:

| Release Type  | Tag Format        | Example       | Artifacts                  |
| ------------- | ----------------- | ------------- | -------------------------- |
| Specification | `spec-v{version}` | `spec-v0.5.0` | `schemas-{version}.tar.gz` |
| CLI           | `cli-v{version}`  | `cli-v0.7.2`  | PyPI package               |

## Correct Release Workflow

### Specification Release

When making changes to the specification (schemas, layer definitions, etc.):

```
1. Edit spec files in spec/ directory
   └── spec/schemas/*.schema.json
   └── spec/layers/*.md
   └── spec/VERSION

2. Update spec/VERSION with new version number

3. Commit changes to main branch
   git add spec/
   git commit -m "Spec: [description of changes]"

4. Create and push spec release tag
   git tag spec-v0.5.0
   git push origin spec-v0.5.0

5. GitHub Actions creates release with schemas tarball
   └── Release: spec-v0.5.0
   └── Asset: schemas-0.5.0.tar.gz
```

### CLI Release (Depends on Spec Release)

When releasing a new CLI version:

```
1. Update cli/src/documentation_robotics/versions.py (SINGLE SOURCE OF TRUTH)
   └── CLI_VERSION = "0.7.2"      # Increment for CLI release
   └── SPEC_VERSION = "0.5.0"     # Must match existing spec release
   └── VIEWER_VERSION = "0.1.0"   # Update if viewer changed

2. Update cli/CHANGELOG.md with release notes

4. Run prepare_build.py to fetch schemas from GitHub release
   python scripts/prepare_build.py --verbose

   This will:
   - Fetch schemas-0.5.0.tar.gz from spec-v0.5.0 release
   - Extract to cli/src/documentation_robotics/schemas/bundled/
   - Copy integration files

5. Test the build locally
   cd cli
   pip install -e .
   pytest
   dr conformance

6. Commit changes (bundled schemas are gitignored)
   git add cli/
   git commit -m "CLI release v0.7.2"

7. Create and push CLI release tag
   git tag cli-v0.7.2
   git push origin cli-v0.7.2

8. GitHub Actions builds and publishes to PyPI
```

## Version Dependencies

```
CLI Version → Spec Version (via spec_version.py)
    │
    └── prepare_build.py fetches from GitHub release
            │
            └── spec-v{SPEC_VERSION} release must exist
                    │
                    └── schemas-{SPEC_VERSION}.tar.gz asset
```

**Rule**: A CLI release can only reference a spec version that has already been released on GitHub.

## Common Mistakes to Avoid

### 1. Editing Bundled Schemas Directly

**Wrong**:

```bash
# NEVER DO THIS
vim cli/src/documentation_robotics/schemas/bundled/09-ux-layer.schema.json
```

**Correct**:

```bash
# Edit the source schema
vim spec/schemas/09-ux-layer.schema.json

# Create spec release
git tag spec-v0.5.1
git push origin spec-v0.5.1

# Update CLI to use new spec version
# (after spec release is published)
vim cli/src/documentation_robotics/spec_version.py
python scripts/prepare_build.py
```

### 2. Releasing CLI Before Spec

**Wrong**:

```bash
# Spec changes not released yet
vim spec/schemas/09-ux-layer.schema.json
git commit -m "Fix schema"

# CLI release fails - no spec release exists!
python scripts/prepare_build.py  # ERROR: Release not found
```

**Correct**:

```bash
# First: Release spec
vim spec/schemas/09-ux-layer.schema.json
git commit -m "Spec: Fix schema"
git tag spec-v0.5.1
git push origin spec-v0.5.1

# Wait for GitHub Action to complete

# Then: Release CLI
python scripts/prepare_build.py  # Success!
```

### 3. Using --local Without Understanding

The `--local` flag bypasses GitHub and uses local schemas:

```bash
# Only use for development/testing
python scripts/prepare_build.py --local

# For releases, always use default (GitHub fetch)
python scripts/prepare_build.py
```

**Warning**: Using `--local` for a release can bundle schemas that don't match any published spec version.

## Verification Steps

### Before Spec Release

```bash
# Verify schemas are valid JSON
python -c "import json; [json.load(open(f)) for f in glob.glob('spec/schemas/*.json')]"

# Run schema validation tests
cd cli && pytest tests/unit/test_schemas.py

# Check VERSION file
cat spec/VERSION
```

### Before CLI Release

```bash
# Verify spec release exists
curl -s https://api.github.com/repos/tinkermonkey/documentation_robotics/releases/tags/spec-v0.5.0 | jq '.tag_name'

# Verify schemas can be fetched
python scripts/prepare_build.py --dry-run --verbose

# Full build test
python scripts/prepare_build.py
cd cli
pip install -e .
pytest
dr conformance
```

### After Release

```bash
# Verify PyPI package
pip install documentation-robotics=={version}
dr --version
dr conformance
```

## Emergency: Fixing a Bad Release

If bundled schemas were accidentally modified and committed:

```bash
# 1. Restore bundled schemas from spec release
python scripts/prepare_build.py --spec-version {correct_version}

# 2. Verify the fix
cd cli && pytest

# 3. Commit the fix
git add cli/src/documentation_robotics/schemas/bundled/
git commit -m "Fix: Restore bundled schemas from spec release"
```

## File Reference

| File                              | Purpose                          | Edit Directly? |
| --------------------------------- | -------------------------------- | -------------- |
| `spec/schemas/*.json`             | Authoritative schema definitions | Yes            |
| `spec/VERSION`                    | Spec version number              | Yes            |
| `cli/src/.../versions.py`         | **ALL CLI/Spec/Viewer versions** | **YES**        |
| `cli/src/.../spec_version.py`     | Legacy re-export (deprecated)    | No             |
| `cli/src/.../schemas/bundled/`    | Bundled schemas for CLI          | **NO**         |
| `cli/src/.../claude_integration/` | Claude Code integration          | **NO**         |
| `scripts/prepare_build.py`        | Build preparation script         | Yes            |

## Troubleshooting

### "Release not found" Error

The spec release doesn't exist yet:

```bash
# Check if release exists
curl -s https://api.github.com/repos/tinkermonkey/documentation_robotics/releases/tags/spec-v0.5.0

# If not, create it first
git tag spec-v0.5.0
git push origin spec-v0.5.0
```

### "Version mismatch" Warning

Local spec/VERSION doesn't match SPEC_VERSION in CLI:

```bash
# Check versions
cat spec/VERSION
grep SPEC_VERSION cli/src/documentation_robotics/spec_version.py

# They should match if using --local
```

### Bundled Schemas Are Stale

The bundled schemas don't match the expected spec version:

```bash
# Re-fetch from GitHub
python scripts/prepare_build.py --verbose

# Or from local (development only)
python scripts/prepare_build.py --local
```

## Related Documentation

- [BUILDING.md](BUILDING.md) - Build process details
- [CONTRIBUTING.md](CONTRIBUTING.md) - Contribution guidelines
- [cli/CHANGELOG.md](cli/CHANGELOG.md) - CLI release history
- [spec/CHANGELOG.md](spec/CHANGELOG.md) - Spec release history
