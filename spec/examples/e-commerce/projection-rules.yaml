# Projection Rules for E-Commerce Example
#
# Demonstrates advanced projection patterns for multi-service systems
# including conditional projection, property transformations, and
# cross-layer traceability automation.

projections:
  # Project strategic goals to business capabilities
  - name: goals-to-business-services
    from: motivation.goal
    to: business.service
    conditions:
      - field: properties.kpis
        operator: exists
      - field: properties.priority
        operator: exists
    rules:
      - create_type: service
        name_template: "{source.name} Management"
        properties:
          description:
            target: description
            transform: template
            transform_value: "Business service supporting goal: {value}"
            source: description
          criticality:
            target: properties.criticality
            source: properties.priority
            transform: lowercase
          supports_goals:
            target: properties.supports_goals
            transform: template
            transform_value: "[{value}]"
            source: id
          kpis:
            target: properties.kpis
            source: properties.kpis
        create_bidirectional: true

  # Project business services to application microservices
  - name: business-to-microservices
    from: business.service
    to: application.service
    conditions:
      - field: properties.supports_goals
        operator: exists
    rules:
      - create_type: service
        name_template: "{source.name_pascal}Service"
        properties:
          description:
            target: description
          runtime:
            target: properties.runtime
            default: "java-spring-boot"
          version:
            target: properties.version
            default: "1.0.0"
          realizes:
            target: properties.realizes
            source: id
          supports_goals:
            target: properties.supports_goals
            source: properties.supports_goals
          criticality:
            target: properties.criticality
            source: properties.criticality
            required: false
        create_bidirectional: true

  # Project critical services to monitoring metrics
  - name: critical-services-to-metrics
    from: application.service
    to: apm.metric
    conditions:
      - field: properties.criticality
        operator: equals
        value: critical
    rules:
      - create_type: metric
        name_template: "{source.name_kebab}-availability"
        properties:
          metric_name:
            target: properties.metric_name
            transform: snake
            source: name
          metric_type:
            target: properties.metric_type
            default: "gauge"
          unit:
            target: properties.unit
            default: "percent"
          target_value:
            target: properties.target_value
            default: 99.9
          aggregation:
            target: properties.aggregation
            default: "avg"
          monitors:
            target: properties.monitors
            source: id
          measures_goal:
            target: properties.measures_goal
            source: properties.supports_goals
        create_bidirectional: true

  # Project PCI DSS compliant services to security policies
  - name: pci-services-to-security
    from: application.service
    to: security.policy
    conditions:
      - field: properties.compliance
        operator: contains
        value: "PCI"
    rules:
      - create_type: policy
        name_template: "{source.name} PCI Compliance Policy"
        properties:
          policy_type:
            target: properties.policy_type
            default: "compliance"
          compliance_framework:
            target: properties.compliance_framework
            default: "PCI DSS Level 1"
          applies_to:
            target: properties.applies_to
            transform: template
            transform_value: "[{value}]"
            source: id
          enforcement:
            target: properties.enforcement
            default: "mandatory"
        create_bidirectional: true

  # Project services with API endpoints to OpenAPI specs
  - name: services-to-api-specs
    from: application.service
    to: api.operation
    conditions:
      - field: properties.runtime
        operator: exists
    rules:
      - create_type: operation
        name_template: "List {source.name}s"
        properties:
          method:
            target: properties.method
            default: "GET"
          path:
            target: properties.path
            transform: template
            transform_value: "/api/v1/{value}"
            source: name_kebab
          service:
            target: properties.service
            source: id
          auth_required:
            target: properties.security.authentication_required
            default: true
          rate_limit:
            target: properties.rate_limit
            default: 1000
        create_bidirectional: true

  # Project user-facing services to UX screens
  - name: user-services-to-ux
    from: application.service
    to: ux.screen
    conditions:
      - field: properties.realizes
        operator: contains
        value: "customer"
    rules:
      - create_type: screen
        name_template: "{source.name} Page"
        properties:
          screen_type:
            target: properties.screen_type
            default: "page"
          platform:
            target: properties.platform
            default: "web"
          uses_service:
            target: properties.uses_service
            source: id
          requires_auth:
            target: properties.requires_auth
            default: true
        create_bidirectional: true

  # Project UX screens to navigation routes
  - name: ux-to-navigation
    from: ux.screen
    to: navigation.route
    conditions:
      - field: properties.platform
        operator: equals
        value: "web"
    rules:
      - create_type: route
        name_template: "{source.name_kebab}"
        properties:
          path:
            target: properties.path
            transform: template
            transform_value: "/{value}"
            source: name_kebab
          component:
            target: properties.component
            transform: pascal
            source: name
          requires_auth:
            target: properties.guards.authentication_required
            source: properties.requires_auth
          screen:
            target: properties.screen
            source: id
        create_bidirectional: true

  # Project services with data operations to database tables
  - name: services-to-datastore
    from: application.service
    to: datastore.table
    conditions:
      - field: properties.runtime
        operator: exists
    rules:
      - create_type: table
        name_template: "{source.name_snake}s"
        properties:
          table_name:
            target: properties.table_name
            transform: snake
            source: name
          database:
            target: properties.database
            default: "postgresql"
          owner_service:
            target: properties.owner_service
            source: id
          created_by:
            target: properties.created_by
            source: id
        create_bidirectional: true

  # Project high-value goals to APM SLIs
  - name: goals-to-sli
    from: motivation.goal
    to: apm.metric
    conditions:
      - field: properties.kpis
        operator: exists
      - field: properties.target_value
        operator: gt
        value: 0
    rules:
      - create_type: sli
        name_template: "{source.name_kebab}-sli"
        properties:
          metric_name:
            target: properties.metric_name
            transform: snake
            source: name
          sli_type:
            target: properties.sli_type
            default: "availability"
          target_value:
            target: properties.target_value
            source: properties.target_value
          current_value:
            target: properties.current_value
            default: 0
          measures_goal:
            target: properties.measures_goal
            source: id
        create_bidirectional: true
# Advanced Features Demonstrated:
#
# 1. Multiple Conditions:
#    - Field existence checks
#    - Value equality checks
#    - Substring matching
#    - Numeric comparisons
#
# 2. Property Transformations:
#    - Case conversions (pascal, kebab, snake, uppercase, lowercase)
#    - Template-based generation with {value} placeholder
#    - Default values for missing properties
#    - Required property validation
#
# 3. Bidirectional Relationships:
#    - Automatic creation of reverse references
#    - Cross-layer traceability
#    - Supports tracing from goals to metrics
#
# 4. Conditional Projection:
#    - Only project elements matching criteria
#    - Support for compliance-driven projection (PCI DSS)
#    - Priority-based projection
#
# 5. Naming Templates:
#    - Access source properties: {source.name}, {source.id}
#    - Use transformed names: {source.name_kebab}, {source.name_pascal}, {source.name_snake}
#    - Combine with static text: "List {source.name}s"
